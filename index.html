<!DOCTYPE HTML>
<html>
  <head>
    <title>diarissues</title>
    <meta name="description" content="Get a diary with Issues and Milestones">
    <meta name="author" content="petrosh">
    <link href="github-markdown.css" media="all" rel="stylesheet" />
    <link href="github.css" media="all" rel="stylesheet" />
    <!-- scripts -->
    <script src="tinytim.min.js"></script>
    <script src="ghre.js"></script>
    <style>span.language{display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;}</style>
  </head>
  <body>
    <div id="issues"></div>
    
    <!-- templates -->

    <script type="text/tim" id="tim_labels">
      <span class="language" style="background-color:#{{color}};"></span> {{name}}
    </script>

    <script type="text/tim" id="tim_mile">in <strong>{{title}}</strong>: {{description}}</script>

    <script type="text/tim" id="tim_issue">
      <div class="markdown-body">
        <h3><a href='{{html_url}}'>{{title}}</a></h3>
        {{body_html}}
        <small>{{timedate}}</small>
        <p>{{html_labels}} {{html_milestone}}</p>
      </div>
    </script>

    <!-- scripts -->

    <script type="text/javascript">
      var pathArray = window.location.host.split( '.' );
      console.log(pathArray[0]);
      var timlabel = document.getElementById("tim_labels").innerHTML;
      var timmile = document.getElementById("tim_mile").innerHTML;
      var timissue = document.getElementById("tim_issue").innerHTML;

      // getURLInfo() completes immediately...
      getAPI(
        "repos/petrosh/diarissues/issues",
        // ...however, the callback function is invoked AFTER the response arrives
        function() {
          // "this" is the XHR object here!
          var resp = JSON.parse(this.responseText);
          for (var key in resp) {
            if (resp.hasOwnProperty(key)) {
              var obj = resp[key];
              console.log(obj);
              var singlel = '';
              for (var f in obj['labels']) {
                if (obj['labels'].hasOwnProperty(f)){
                  singlel += tim(timlabel, obj['labels'][f]);
                }
              };
              obj['html_labels'] = singlel;
              obj['timedate'] = new Date(Date.parse(obj['created_at']));
              obj['html_milestone'] = tim(timmile, obj['milestone']);
              var rep = tim(timissue, obj);
              document.getElementById("issues").innerHTML += rep;
            }
          }
        }
      );
    </script>
  </body>
</html>
